<% content_for :head do %>
  <%= javascript_include_tag "https://ajax.aspnetcdn.com/ajax/jquery.validate/1.8.1/jquery.validate.min.js" %>
  <%= javascript_include_tag "https://js.stripe.com/v1/" %>

  <script type="text/javascript">
    Stripe.setPublishableKey('<%= ENV['PUBLISHABLE_KEY'] %>');
    $(document).ready(function() {
      function addInputNames() {
        // Not ideal, but jQuery's validate plugin requires fields to have names
        // so we add them at the last possible minute, in case any javascript
        // exceptions have caused other parts of the script to fail.
        $(".card-number").attr("name", "card-number");
        $(".card-cvc").attr("name", "card-cvc");
        $(".card-expiry-year").attr("name", "card-expiry-year");
      }

      function removeInputNames() {
        $(".card-number").removeAttr("name");
        $(".card-cvc").removeAttr("name");
        $(".card-expiry-year").removeAttr("name");
      }

      function submit(form) {
        // remove the input field names for security
        // we do this *before* anything else which might throw an exception
        removeInputNames(); // THIS IS IMPORTANT!

        // given a valid form, submit the payment details to stripe
        $(form['submit-button']).attr("disabled", "disabled")

        Stripe.createToken({
          number: $('.card-number').val(),
          cvc: $('.card-cvc').val(),
          exp_month: $('.card-expiry-month').val(),
          exp_year: $('.card-expiry-year').val()
        }, function(status, response) {
          if (response.error) {
            // re-enable the submit button
            $(form['submit-button']).removeAttr("disabled")

            // show the error
            $(".payment-errors").html(response.error.message);

            // we add these names back in so we can revalidate properly
            addInputNames();
          } else {
            // token contains id, last4, and card type
            var token = response['id'];

            // insert the stripe token
            var input = $("<input name='stripeToken' value='" + token + "' style='display:none;' />");
            form.appendChild(input[0])

            // and submit
            form.submit();
          }
        });

        return false;
      }

      // add custom rules for credit card validating
      jQuery.validator.addMethod("cardNumber", Stripe.validateCardNumber, "Please enter a valid card number");
      jQuery.validator.addMethod("cardCVC", Stripe.validateCVC, "Please enter a valid security code");
      jQuery.validator.addMethod("cardExpiry", function() {
        return Stripe.validateExpiry($(".card-expiry-month").val(),
          $(".card-expiry-year").val())
      }, "Please enter a valid expiration");

      // We use the jQuery validate plugin to validate required params on submit
      $("#example-form").validate({
        submitHandler: submit,
        rules: {
          "card-cvc" : {
            cardCVC: true,
            required: true
          },
          "card-number" : {
            cardNumber: true,
            required: true
          },
          "card-expiry-year" : "cardExpiry" // we don't validate month separately
        }
      });

      // adding the input field names is the last step, in case an earlier step errors
      addInputNames();
    });
  </script>
<% end %>

<div class="container join">
  <h1><%= @creatable.membership.name %></h1>
  <span class="fee">
    <span class="amount"><span class="dollar-sign">$</span><%= @creatable.membership.fee %></span>
    <%= "/#{@creatable.membership.renewal_text}" %>
  </span>
  <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Praesent lobortis metus dui, nec egestas nibh scelerisque in. </p>

  <div class="invite-wrap">
    <%= form_for @member, :url => members_create_path(:creatable_id => @creatable.id) do |f| %>
      <%= f.error_messages %>
      <div class="personal-info">
        <h3>Personal Information</h3>
        <%= f.text_field :full_name, :placeholder => "Full Name" %>
        <%= f.text_field :email, :placeholder => "Email" %>
        <%= f.text_field :phone, :placeholder => "Phone" %>
        <br/>
        <%= f.text_field :street_address, :placeholder => "Street Address" %>
        <%= f.text_field :city, :placeholder => "City" %>
        <%= f.text_field :state, :placeholder => "Province/State" %>
        <%= f.text_field :zipcode, :placeholder => "Postal/Zip Code" %>
        <%= f.text_field :country, :placeholder => "Country" %>
      </div>
      <div class="billing">
        <h3>Billing</h3>
        <p>You will be charged <span class="bold">$<%= "#{@creatable.membership.fee}/#{@creatable.membership.renewal_text}" %></span></p>
      </div>
      <%= f.submit "Submit", :class => "btn" %>
    <% end %>
  </div>
</div>